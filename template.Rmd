---
title: "Meteorological Station on the Iquitos - Nauta road üéè"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    logo: https://user-images.githubusercontent.com/39299104/207467842-d92416da-c312-4a9c-9cbf-a23a93da6465.png
    favicon: https://raw.githubusercontent.com/healthinnovation/innovar/gh-pages/favicon.ico
    navbar:
        - { icon: "fa-home", href: "https://healthinnovation.github.io/harmonize", align: right, title: "Return home"}
runtime: shiny
---
<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto+Slab&display=swap');
body{
    font-family: 'Roboto Slab', serif;
}

.navbar{
    padding-left: 28px;
}

.navbar-logo {
    margin-top: 2px;
    width: 36.5px;
    position: fixed;
    left: 2px;
    margin-bottom: 2px;
}

.navbar-inverse {
    background-color: #070807;
    border-color: #070807;
}
.navbar-inverse .navbar-brand {
    color: #ffffff;
}
.navbar-inverse .navbar-nav>.active>a, .navbar-inverse .navbar-nav>.active>a:hover, .navbar-inverse .navbar-nav>.active>a:focus {
    color: #ffffff;
    background-color: #ffffff2e;
}
.navbar-inverse .navbar-nav>li>a {
    color: #ffffff;
}
.navbar-inverse .navbar-brand:hover, .navbar-inverse .navbar-brand:focus {
    color: #ffffff;
    background-color: #ffffff00;
}
.section.sidebar {
    top: 51px;
    background-color: rgb(255 255 255);
}
</style>

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(leaflet)
library(sf)
library(tidyverse)
library(pixture)
library(plotly)
library(lubridate)
sp <- read_sf("https://github.com/healthinnovation/harmonize/raw/main/data/processed/tracking_area_by_communities.gpkg") %>% filter(village %in% c("12 DE ABRIL","SAN LUCAS", "EL PAUJIL", "EL VARRILLAL","QUISTOCOCHA")) %>%
  st_cast('POLYGON') %>%
  mutate(village = case_when(
    village == "EL VARRILLAL" ~ "EL VARILLAL",
    TRUE ~village
  ))

pto <- read_sf("resources/metheorological_station_location.gpkg") %>%
  st_cast('POINT') %>%
  mutate(nombre = case_when(
    nombre == "VARRILLAL" ~ "EL VARILLAL",
    TRUE~nombre
  ))
  
weather_sations_df_long <- read_csv("resources/weather_stations_long.csv") %>%
  mutate(Community = str_to_upper(Community)) %>%
    mutate(Community = case_when(
    Community == "PAUJIL" ~ "EL PAUJIL",
    Community == "VARILLAL" ~ "EL VARILLAL",
    TRUE~Community
  ))

pm2_total_long <- read_csv("resources/pm2_total_long.csv")
```

Sidebar {.sidebar}
-----------------------------------------------------------------------
```{r, out.width=100}
selectInput(
   inputId = "village",
   label = "Selected community üîé", 
   choices = c("ALL","QUISTOCOCHA","12 DE ABRIL","EL PAUJIL","SAN LUCAS", "EL VARILLAL"),
   multiple = FALSE
   )
```

<p>A web interface that showcases the distribution and data from weather stations and air quality monitors along the Iquitos - Nauta highway axis. The equipment has been installed in 5 communities and collects various data including humidity, temperature, precipitation, as well as PM2.5 and PM10 particles.
</p>
<br/>
<img src='https://raw.githubusercontent.com/healthinnovation/harmonize/main/img/Harmonize_logo.png' width='70%' align='left'>
<br/>
<br/>
<br/>
<br/>
<br/>
<img src='https://raw.githubusercontent.com/healthinnovation/harmonize/app/icons/cayetano.svg' width='70%'>



Column
-----------------------------------------------------------------------

### {data-width=1750}

```{r}
output$map <- renderLeaflet({
  
  output$map <- renderLeaflet({
    leaflet() %>%
      addProviderTiles(provider = providers$Esri.WorldImagery,group = "Esri.WorldImagery") 
  })

  observe({
    comunidad <- input$village
    if (comunidad == "ALL"){
      region <- sp
      leafletProxy("map") %>%
        clearShapes() %>%
        addPolygons(
          data = region,
          color = "yellow",
          fill = NA,
          weight = 3,
          opacity = 1
          ) %>%
        addMarkers(data = pto,icon = iconList("Meteorological station" = makeIcon("https://raw.githubusercontent.com/ambarja/utilsUPCH/37eaf7c2fd380449b038a5804955e98cfd1fd7bc/estacion_meteorologica_v2.svg",iconWidth = 20,iconHeight = 20)),popup = pto$clasificacion) %>%

        setView(lng = -73.39127,lat =-4.03404 ,zoom = 9)
    }else{
      estacion <- pto %>% filter(nombre %in% comunidad)
      region <- sp %>% filter(village %in% comunidad)
      bbox <- region %>% st_bbox()
      lng <- (bbox[["xmin"]] + bbox[["xmax"]])/2 
      lat <- (bbox[["ymin"]] + bbox[["ymax"]])/2
      leafletProxy("map") %>%
        clearShapes() %>%
        clearMarkers() %>%
        addPolygons(
          data = region,
          color = "yellow",
          fill = NA,
          weight = 2,
          opacity = 1) %>%
        addMarkers(data = estacion,icon = iconList("Meteorological station" = makeIcon("https://raw.githubusercontent.com/ambarja/utilsUPCH/main/estacion_meteorologica.svg",iconWidth = 20,iconHeight = 20)),popup = estacion$clasificacion) %>%
        
        flyTo(lng = lng,lat = lat,zoom = 15)
    }
    
  })
})
leafletOutput('map')

```


### 

```{r out.width="100%"}
### Temperature
renderUI({
  
  comunidad <- input$village
  if(comunidad == "ALL"){
    renderPixfigure({
      paths <- "https://user-images.githubusercontent.com/23284899/241096084-d2265c39-bdb4-40ca-8eaf-e15a730483b1.jpg"
      pixfigure(paths)
    })
  } else {
    ggplotly(
    weather_sations_df_long %>% 
      filter(variables %in% c("Temp_out"),Community == comunidad) %>% 
      mutate(
        fecha = ymd_hms(paste(Date, Time))
        ) %>% 
      ggplot(aes(x = fecha, y = value)) + 
      geom_line(col = "#FF3030") +
      labs(
        y = "", 
        x = "", 
        title = "Temperature ÀöC"
        ) +
      theme_bw()) %>% config(displayModeBar = FALSE)
    }
})
```



Column {data-width=350}
-----------------------------------------------------------------------

### 

```{r out.width="100%"}
renderUI({
  
  comunidad <- input$village
  
  if(comunidad == "ALL"){
    renderPixfigure({
      paths <- "https://user-images.githubusercontent.com/23284899/241096089-e6c0df8a-aab0-44fa-9ef9-4e904385c58e.jpg"
      pixfigure(paths)
    })
  } else{
      ggplotly(
          weather_sations_df_long %>% 
            filter(variables %in% c("Rain"),Community == comunidad) %>% 
            mutate(
              fecha = ymd_hms(paste(Date, Time))
              ) %>% 
            ggplot(aes(x = fecha, y = value)) + 
            geom_line(col = "#1E90FF") +
            labs(
              y = "", 
              x = "", 
              title = "Rain (mm)"
              ) +
            theme_bw()) %>% 
          config(displayModeBar = FALSE)
        }
})

```

### 

```{r}
renderUI({
  
  comunidad <- input$village
  if(comunidad == "ALL"){
    renderPixfigure({
      paths <- "https://user-images.githubusercontent.com/23284899/241096093-cc752bb7-9477-4ecc-ba6b-a2823b9bb73a.jpg"
      pixfigure(paths)
    })
  } else {
    ggplotly(
    weather_sations_df_long %>% 
      filter(variables %in% c("Out_Humm"),Community == comunidad) %>% 
      mutate(
        fecha = ymd_hms(paste(Date, Time))
        ) %>% 
      ggplot(aes(x = fecha, y = value)) + 
      geom_line(col = "#87CEEB") +
      labs(
        y = "", 
        x = "", 
        title = "Humidity"
        ) +
      theme_bw()) %>% 
      config(displayModeBar = FALSE)
    }
})
```


### 

```{r}
## Pm 2.5
renderUI({
  
  comunidad <- input$village
  if(comunidad == "ALL"){
    renderPixfigure({
      paths <- "https://user-images.githubusercontent.com/23284899/241096098-f3be7565-324c-4114-82e5-cf18075b9305.jpg"
      pixfigure(paths)
    })
  } else {
    ggplotly(
    pm2_total_long  %>% 
      filter(variables %in% c("p_2_5_um"),Community == comunidad) %>% 
      ggplot(aes(x = UTCDateTime, y = value)) + 
      geom_line(col = "#FF8247") +
      labs(
        y = "", 
        x = "", 
        title = "Pm2.5"
        ) +
      theme_bw()) %>% config(displayModeBar = FALSE)
    }
})
```

### 

```{r}
## Pm10
renderUI({
  
  comunidad <- input$village
  if(comunidad == "ALL"){
    renderPixfigure({
      paths <- "https://user-images.githubusercontent.com/23284899/241096092-c70968d2-6b0f-4700-8157-3d59487cd04c.jpg"
      pixfigure(paths)
    })
  } else {
    ggplotly(
    pm2_total_long %>% 
      filter(variables %in% c("p_10_0_um"),Community == comunidad) %>% 
      ggplot(aes(x = UTCDateTime, y = value)) + 
      geom_line(col = "#3CB371") +
      labs(
        y = "", 
        x = "", 
        title = "Pm10"
        ) +
      theme_bw()) %>% config(displayModeBar = FALSE)
    }
})

```

