---
title: "Estaci√≥n meteorol√≥gica en la carretera Iquitos - Nauta üéè"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    logo: https://user-images.githubusercontent.com/39299104/207467842-d92416da-c312-4a9c-9cbf-a23a93da6465.png
    favicon: https://raw.githubusercontent.com/healthinnovation/innovar/gh-pages/favicon.ico
    navbar:
        - { icon: "fa-home", href: "https://healthinnovation.github.io/harmonize", align: right, title: "Volver a inicio"}
runtime: shiny
---

```{=html}
<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto+Slab&display=swap');
body{
    font-family: 'Roboto Slab', serif;
}

.navbar{
    padding-left: 28px;
}

.navbar-logo {
    margin-top: 2px;
    width: 36.5px;
    position: fixed;
    left: 2px;
    margin-bottom: 2px;
}

.navbar-inverse {
    background-color: #070807;
    border-color: #070807;
}
.navbar-inverse .navbar-brand {
    color: #ffffff;
}
.navbar-inverse .navbar-nav>.active>a, .navbar-inverse .navbar-nav>.active>a:hover, .navbar-inverse .navbar-nav>.active>a:focus {
    color: #ffffff;
    background-color: #ffffff2e;
}
.navbar-inverse .navbar-nav>li>a {
    color: #ffffff;
}
.navbar-inverse .navbar-brand:hover, .navbar-inverse .navbar-brand:focus {
    color: #ffffff;
    background-color: #ffffff00;
}
.section.sidebar {
    top: 51px;
    background-color: rgb(255 255 255);
}
</style>
```

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(leaflet)
library(sf)
library(tidyverse)
library(pixture)
library(plotly)
library(lubridate)
library(leaflet.extras)
library(ggthemr)
```

```{r}
weather <- read_csv(
  "data/app/weather-stations.csv", 
  col_types = "DTddddddcddcddddddddddddddddddccDiii"
)

quality <- read_csv(
  "data/app/quality-stations.csv",
  col_types = paste(c("DTccc", rep("d", 37), "ccDiii"), collapse = "")
)
```

```{r}
weather_long <- weather |> 
  pivot_longer(
    -c(
      cutoff_date, dttm, ccpp_ubigeo, ccpp_name, day, week, month, year,
      where(is.character)
    ),
    names_to = "variable",
    values_to = "value"
  )

quality_long <- quality |> 
  pivot_longer(
    -c(
      cutoff_date, dttm, ccpp_ubigeo, ccpp_name, day, week, month, year,
      where(is.character)
    ),
    names_to = "variable",
    values_to = "value"
  )
```

```{r}
sp <- read_sf("data/app/tracking_area_by_communities.gpkg") |> 
  filter(
    village %in% c(
      "12 DE ABRIL","SAN LUCAS", "EL PAUJIL", "EL VARRILLAL", "QUISTOCOCHA"
    )
  ) |>
  st_cast('POLYGON') |>
  mutate(
    village = case_when(village == "EL VARRILLAL" ~ "EL VARILLAL", TRUE~village)
  )

pto <- read_sf("data/app/metheorological_station_location.gpkg") |>
  st_cast('POINT') |>
  mutate(
    nombre = case_when(nombre == "VARRILLAL" ~ "EL VARILLAL", TRUE~nombre)
  )
```

## Sidebar {.sidebar}

```{r out.width=100}
selectInput(
   inputId = "village", label = "Seleccione una comunidad üîé", 
   choices = c(
       "Elige uno" = "", "Quistococha", "12 de Abril", "El Paujil", "San Lucas", 
     "El Varillal"
   ),
   multiple = FALSE
)
```

```{r out.width=100}
selectInput(
  inputId = "unit", label = "Unidad de tiempo‚åö",
  choices = c("Hora"="Hour", "D√≠a"="Day", "Semana"="Week","Mes"="Month", "A√±o"="Year"),
  multiple = FALSE
)
```

```{r out.width=100}
sliderInput(
  inputId = "slider_date", label = "Rango de fechaüìÜ",
  min = min(c(min(weather$dttm), min(quality$dttm))),
  max = max(c(max(weather$dttm), max(quality$dttm))),
  value = c(
    min(c(min(weather$dttm), min(quality$dttm))),
    max(c(max(weather$dttm), max(quality$dttm)))
  ), step = 3600, ticks = FALSE
)
```



```{r}
observeEvent(
  input$unit, {
    if (input$unit == "Hour") {
      range_min = c(min(weather$dttm), min(quality$dttm))
      range_max = c(max(weather$dttm), max(quality$dttm))
      updateSliderInput(
        session, "slider_date", min = min(range_min), max = max(range_max),
        value = c(min(range_min), max(range_max)),  step = 3600
      )
    } else if (input$unit == "Day") {
      range_min = c(min(weather$day), min(quality$day))
      range_max = c(max(weather$day), max(quality$day))
      updateSliderInput(
        session, "slider_date", min = min(range_min), max = max(range_max),
        value = c(min(range_min), max(range_max)), step = 1
      )
    } else if (input$unit == "Week") {
      range_min = c(min(weather$week), min(quality$week))
      range_max = c(max(weather$week), max(quality$week))
      updateSliderInput(
        session, "slider_date", min = min(range_min), max = max(range_max),
        value = c(min(range_min), max(range_max)), step = 1
      )
    } else if (input$unit == "Month") {
      range_min = c(min(weather$month), min(quality$month))
      range_max = c(max(weather$month), max(quality$month))
      updateSliderInput(
        session, "slider_date", min = min(range_min), max = max(range_max),
        value = c(min(range_min), max(range_max)), step = 1
      )
    } else {
      range_min = c(min(weather$year), min(quality$year))
      range_max = c(max(weather$year), max(quality$year))
      updateSliderInput(
        session, "slider_date", min = min(range_min), max = max(range_max),
        value = c(min(range_min), max(range_max)), step = 1
      )
    }
  }
)
```

<br>
<p>Una interfaz web que muestra la distribuci√≥n y los datos de las estaciones meteorol√≥gicas y los monitores de calidad del aire a lo largo del eje carretero Iquitos - Nauta. Los equipos se han instalado en 5 comunidades y recogen diversos datos como humedad, temperatura, precipitaciones, as√≠ como part√≠culas PM2,5 y PM10.
</p>
<br/> <img src="https://raw.githubusercontent.com/healthinnovation/harmonize/main/img/Harmonize_logo.png" width="70%" align="left"/> <br/> <br/> <br/> <br/> <br/> <img src="https://raw.githubusercontent.com/healthinnovation/harmonize/app/icons/cayetano.svg" width="70%"/>

<br>
<br>
<br>
<br>
<br>
<br>
<center>
<button type="button" class="btn btn-primary" style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;"><a href="#" style='color:white;'>√öltimo registro: 27-07-2023</a>
</button>
</center>

## Column

###  {data-width="1750"}

```{r}
icon_station = "https://raw.githubusercontent.com/ambarja/utilsUPCH/main/estacion_meteorologica.svg"
icon_station_v2 = "https://raw.githubusercontent.com/ambarja/utilsUPCH/37eaf7c2fd380449b038a5804955e98cfd1fd7bc/estacion_meteorologica_v2.svg"
```

```{r}
output$map <- renderLeaflet({
  output$map <- renderLeaflet({
    leaflet() |>
      addTiles()
  })
  observe({
    comunidad <- toupper(input$village)
    if (comunidad == ""){
      region <- sp
      leafletProxy("map") |>
        clearShapes() |>
        addPulseMarkers(data = pto,popup = pto$clasificacion,icon = makePulseIcon(heartbeat = 1,color ='#ff1101')) |> 
        # addMarkers(
        #   data = pto, 
        #   icon = iconList(
        #     "Meteorological station" = makeIcon(
        #       icon_station_v2, iconWidth = 20, iconHeight = 20
        #     )
        #   ),
        #   popup = pto$clasificacion
        # ) |>
        setView(lng = -73.39127,lat =-4.03404 ,zoom = 10)
    } else {
      estacion <- pto |> filter(nombre %in% comunidad)
      region <- sp |> filter(village %in% comunidad)
      bbox <- region |> st_bbox()
      lng <- (bbox[["xmin"]] + bbox[["xmax"]])/2 
      lat <- (bbox[["ymin"]] + bbox[["ymax"]])/2
      leafletProxy("map") |>
        clearShapes() |>
        clearMarkers() |>
        addPolygons(
          data = region,
          color = "black",
          fill = NA,
          weight = 2,
          opacity = 1) |>
        addPulseMarkers(data = pto,popup = pto$clasificacion,icon = makePulseIcon(heartbeat = 1,color ='#ff1101')) |> 
        # addMarkers(
        #   data = estacion, icon = iconList(
        #     "Meteorological station" = makeIcon(
        #       icon_station,iconWidth = 20, iconHeight = 20
        #     )
        #   ),
        #   popup = estacion$clasificacion
        # ) |>
        flyTo(lng = lng,lat = lat,zoom = 15)
    }
  })
})
leafletOutput("map")
```

### 

```{r}
plot_line <- function(data, x, y = value, color, title) {
  ggthemr("dust")
  line_plot <- data |> 
    ggplot(aes(x = {{x}}, y = {{y}})) +
    geom_line(color = color) +
    labs(y = "", x = "", title = title) #+
    #theme_classic()
  ggplotly(p = line_plot) |> 
    config(displayModeBar = FALSE)
}
```

```{r}
plot_unit <- function(data, vars, ccpp, unit, color, title, lower, upper) {
  data_filter <- data |> 
    dplyr::filter(variable == vars, ccpp_name == ccpp)
  if (unit == "Hour") {
    data_plot <- data_filter |> 
      filter(between(dttm, lower, upper))
    plot_line(data = data_plot, x = dttm, y = value, color = color, title = title)
  } else
  if (unit == "Day") {
    data_plot <- data_filter |> 
      group_by(day) |> 
      summarise(value = mean(value, na.rm = TRUE), .groups = "drop") |> 
      filter(between(day, lower, upper)) 
    plot_line(data = data_plot, x = day, y = value, color = color, title = title)
  } else
  if (unit == "Week") {
    data_plot <- data_filter |> 
      group_by(week) |> 
      summarise(value = mean(value, na.rm = TRUE), .groups = "drop") |> 
      filter(between(week, lower, upper)) 
    plot_line(data = data_plot, x = week, y = value, color = color, title = title)
  } else
  if (unit == "Month") {
    data_plot <- data_filter |> 
      group_by(month) |> 
      summarise(value = mean(value, na.rm = TRUE), .groups = "drop") |> 
      filter(between(month, lower, upper)) 
    plot_line(data = data_plot, x = month, y = value, color = color, title = title)
  } else {
    data_plot <- data_filter |> 
      group_by(year) |> 
      summarise(value = mean(value, na.rm = TRUE), .groups = "drop") |> 
      filter(between(year, lower, upper)) 
    plot_line(data = data_plot, x = year, y = value, color = color, title = title)
  }
}
```

```{r}
quistococha_url <- "https://user-images.githubusercontent.com/23284899/241096084-d2265c39-bdb4-40ca-8eaf-e15a730483b1.jpg"
sanlucas_url <- "https://user-images.githubusercontent.com/23284899/241096089-e6c0df8a-aab0-44fa-9ef9-4e904385c58e.jpg"
docedeabril_url <- "https://user-images.githubusercontent.com/23284899/241096093-cc752bb7-9477-4ecc-ba6b-a2823b9bb73a.jpg"
elvarillal_url <- "https://user-images.githubusercontent.com/23284899/241096098-f3be7565-324c-4114-82e5-cf18075b9305.jpg"
elpaujil_url <- "https://user-images.githubusercontent.com/23284899/241096092-c70968d2-6b0f-4700-8157-3d59487cd04c.jpg"
```

```{r out.width="100%"}
# Temperature
renderUI({
  if(input$village == ""){
    renderPixfigure({
      pixfigure(quistococha_url)
    })
  } else {
    plot_unit(
      weather_long, vars = "temp_out", ccpp = toupper(input$village), 
      unit = input$unit, color = "#ACD1C5", title = "Temperatura (ÀöC)", 
      lower = input$slider_date[1], upper = input$slider_date[2] 
    )
  }
})
```

## Column {data-width="350"}

### 

```{r out.width="100%"}
# Rain
renderUI({
  if(input$village == ""){
    renderPixfigure({
      pixfigure(sanlucas_url)
    })
  } else {
    plot_unit(
      weather_long, vars = "rain", ccpp = toupper(input$village), 
      unit = input$unit, color = "#005378", title = "Lluvia (mm)", 
      lower = input$slider_date[1], upper = input$slider_date[2]
    )
  }
})

```

### 

```{r}
# Humidity
renderUI({
  if(input$village == ""){
    renderPixfigure({
      pixfigure(docedeabril_url)
    })
  } else {
    plot_unit(
      weather_long, vars = "out_humm", ccpp = toupper(input$village), 
      unit = input$unit, color = "#006998", title = "Humedad (%)", 
      lower = input$slider_date[1], upper = input$slider_date[2]
    )
  }
})
```

### 

```{r}
# PM2.5
renderUI({
  if(input$village == ""){
    renderPixfigure({
      pixfigure(elvarillal_url)
    })
  } else {
    plot_unit(
      quality_long, vars = "p_2_5_um", ccpp = toupper(input$village), 
      unit = input$unit, color = "#3788AB", title = "PM2.5 (um3) ", 
      lower = input$slider_date[1], upper = input$slider_date[2]
    )
  }
})
```

### 

```{r}
# PM10
renderUI({
  if(input$village == ""){
    renderPixfigure({
      pixfigure(elpaujil_url)
    })
  } else {
    plot_unit(
      quality_long, vars = "p_10_0_um", ccpp = toupper(input$village), 
      unit = input$unit, color = "#75AEBB", title = "PM10 (um3)", 
      lower = input$slider_date[1], upper = input$slider_date[2]
    )
  }
})
```
