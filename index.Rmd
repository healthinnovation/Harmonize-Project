---
title: "Mapeo de enfermedades en la ruta Iqutos - Nautaü¶üüõ£Ô∏è"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    social: menu
    theme: lumen
    logo: https://raw.githubusercontent.com/healthinnovation/innovar/master/man/figures/logo.png
    navbar:
        - {icon: "fa-github", href: "https://github.com/healthinnovation", align: right}
        - { icon: "fa-home", href: "https://healthinnovation.github.io/harmonize", align: left, title: "Return home"}    
    self_contained: false
    lib_dir: "lib"
runtime: shiny
---

```{=html}
<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto+Slab&display=swap');

body{
    font-family: 'Roboto Slab', serif;
}

.navbar{
    padding-left: 28px;
}

.navbar-logo {
    margin-top: 3px;
    width: 45px;
    position: fixed;
    left: 0px;
    margin-bottom: 3px;
}

.navbar-inverse {
    background-color: #070807;
    border-color: #070807;
}
.navbar-inverse .navbar-brand {
    color: #ffffff;
}
.navbar-inverse .navbar-nav>.active>a, .navbar-inverse .navbar-nav>.active>a:hover, .navbar-inverse .navbar-nav>.active>a:focus {
    color: #ffffff;
    background-color: #ffffff2e;
}
.navbar-inverse .navbar-nav>li>a {
    color: #ffffff;
}
.navbar-inverse .navbar-brand:hover, .navbar-inverse .navbar-brand:focus {
    color: #ffffff;
    background-color: #ffffff00;
}

.leaflet-container {
    font: 16px/1.5 'Roboto Slab', serif;
}

.info {
  padding: 6px 8px;
  font-family: 'Roboto Slab', serif;
  box-shadow: 0 0 15px rgba(0,0,0,0.2);
  border-radius: 5px;
  
}
.legend{
 line-height: 6px;
}

</style>
```
```{r setup, include=FALSE}
library(flexdashboard)
library(leaflet)
library(leaflet.extras)
library(tidyverse)
library(htmltools)
library(sf)
library(viridis)
```

```{r echo=FALSE, warning=FALSE,message=FALSE}
db_inventario <- read_csv("data/db_pilot_2023_marzo_test.csv") %>% 
  mutate(village = case_when(
    village == "EL VARRILLAL" ~ "EL VARILLAL",
    TRUE ~ village
  ))
cobertura_b <-  db_inventario %>% filter(type == "cobertura") %>% 
  drop_na(village)
criadero_b <- db_inventario %>% filter(type == "criadero") %>% 
  drop_na(village)

drones <- read_csv("data/drones.csv")

pal_cobertura <- colorFactor(palette = mako(n = 4,direction = -1),domain = unique(cobertura_b$class))
pal_criadero <- colorFactor(palette = plasma(n = 2,direction = -1),domain = unique(criadero_b$class))
```

##  {.sidebar}
<center>
```{r}
selectInput(
   inputId = "village",
   label = h5("Elije una comunidad üîé"), 
   choices = unique(drones$villages) |> sort(),
   multiple = FALSE
   )
```

<br/> <br/> <br/> <br/> <br/> <img src="https://raw.githubusercontent.com/healthinnovation/harmonize/main/img/Harmonize_logo.png" width="70%" align="center"/> <br/> <br/> <br/><img src="https://raw.githubusercontent.com/healthinnovation/harmonize/app/icons/cayetano.svg" width="70%"/>
</center>

## Column {data-height="700"}

### 

```{r out.width='100%'}

output$map <- renderLeaflet({
  
  output$map <- renderLeaflet({
    leaflet() %>% 
      addTiles(group = "OpenStreetMap") %>%
      setView(lng =-73.32608,lat = -3.82371,zoom = 15)
  })
  

    bbox <- st_read("data/flying_mission_1km2.gpkg") %>% 
      distinct(village,.keep_all = T) |> 
      st_transform(crs = 4326) %>% 
      rename(name = village) %>% 
      mutate(name = str_to_upper(name)) 

  observe({
    comunidad <- input$village
    region <- bbox %>% filter(name %in% comunidad) %>% st_bbox()
    
    rgb_drone <- drones %>% 
      filter(villages %in% comunidad) %>% 
      select(rgb) %>% 
      pull()
    
    termal_drone <- drones %>% 
      filter(villages %in% comunidad) %>% 
      select(termal) %>% 
      pull()
    
    criadero <- criadero_b %>% filter(village %in% comunidad)
    cobertura <- cobertura_b %>% filter(village %in% comunidad)
    
    if(comunidad == "QUISTOCOHA"){
      lat <- (region[["ymin"]]+region[["ymax"]])/2
      lon <- (region[["xmin"]] + region[["xmax"]])/2  
      
      leafletProxy("map") %>%
        clearMarkers() %>% 
        addTiles() %>% 
        addTiles(urlTemplate = rgb_drone, group = sprintf("%s-rgb",comunidad),options = providerTileOptions(maxZoom = 22)) %>% 
        addTiles(urlTemplate = termal_drone, group = sprintf("%s-t√©rmico",comunidad),options = providerTileOptions(maxZoom = 22)) %>% 
        addCircleMarkers(
          data = criadero,
          lng = criadero$Longitud,
          lat = criadero$Latitud,
          color = "red",
          group = "criadero",
          popup = criadero$class
          ) %>% 
        addHeatmap(
          data = criadero,
          lng = criadero$Longitud,
          lat = criadero$Latitud,
          radius = 13,
          group = "focos de criadero" 
        ) %>% 
        addCircleMarkers(
          data = cobertura,
          lng = cobertura$Longitud,
          lat = cobertura$Latitud,
          color = "blue",
          group = "cobertura",
          popup = cobertura$class
          ) %>%
        addHeatmap(
          data = cobertura,
          lng = cobertura$Longitud,
          lat = cobertura$Latitud,
          radius = 13,
          group = "focos de cobertura" 
        ) %>% 
        setView(lng = lon,lat = lat,zoom = 10) %>%
        addLayersControl(
          overlayGroups = c("criadero","cobertura", "focus-criadero","focus-cobertura"),
          baseGroups = c("OpenStreetMap",sprintf("%s-rgb",comunidad)),
          options = layersControlOptions(collapsed = FALSE,title = "TITLE")
        ) %>% 
        hideGroup(c("criadero","cobertura","focos de criadero","focos de cobertura"))
          
    } else{
      leafletProxy("map") %>% 
        clearMarkers() %>% 
        addTiles() %>% 
        addTiles(urlTemplate = rgb_drone, group = sprintf("%s-rgb",comunidad),options = providerTileOptions(maxZoom = 22)) %>% 
        addTiles(urlTemplate = termal_drone, group = sprintf("%s-t√©rmico",comunidad),options = providerTileOptions(maxZoom = 22)) %>% 
        addCircleMarkers(
          data = criadero,
          lng = criadero$Longitud,
          lat = criadero$Latitud,
          color = "black",
          radius = 8,
          opacity = 1,
          fillColor = "yellow",
          fillOpacity = 0.8,
          weight = 1,
          group = "criadero",
          popup = criadero$class
          ) %>%
         addHeatmap(
          data = criadero,
          lng = criadero$Longitud,
          lat = criadero$Latitud,
          radius = 13,
          group = "focos de criadero" 
        ) %>% 
        addCircleMarkers(
          data = cobertura,
          lng = cobertura$Longitud,
          lat = cobertura$Latitud,
          color = "black",
          radius = 8,
          opacity = 1,
          fillColor = "blue",
          fillOpacity = 0.8,
          weight = 1,
          group = "cobertura",
          popup = cobertura$class
          ) %>%
        addHeatmap(
          data = cobertura,
          lng = cobertura$Longitud,
          lat = cobertura$Latitud,
          radius = 13,
          group = "focos de cobertura" 
        ) %>% 
        flyToBounds(
          lng1 = region[["xmin"]],
          lat1 = region[["ymin"]],
          lng2 = region[["xmax"]],
          lat2 = region[["ymax"]],
          options = list(zoom = 10)
          ) %>% 
      addLayersControl(
         overlayGroups = c("criadero","cobertura", "focos de criadero","focos de cobertura"),
          baseGroups = c("OpenStreetMap",sprintf("%s-rgb",comunidad), sprintf("%s-t√©rmico",comunidad)),
          options = layersControlOptions(collapsed = FALSE)
      ) %>% 
        hideGroup(c("criadero","cobertura","focos de criadero","focos de cobertura"))}  
  })
})

leafletOutput('map')  
```
